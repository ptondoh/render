<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="SystÃ¨me d'Alerte PrÃ©coce pour la sÃ©curitÃ© alimentaire en HaÃ¯ti">
    <meta name="theme-color" content="#2563eb">

    <title>SAP - SystÃ¨me d'Alerte PrÃ©coce</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">

    <!-- CSS -->
    <link rel="stylesheet" href="/dist/output.css">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>

    <!-- SheetJS pour parser Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="SAP">
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Indicateur de connexion amÃ©liorÃ© -->
    <div id="connection-status" class="hidden fixed top-0 left-0 right-0 z-50 text-white text-center py-3 text-sm font-medium shadow-lg transition-all duration-300">
        <div class="max-w-7xl mx-auto px-4 flex items-center justify-center space-x-2">
            <span id="connection-icon">ðŸ“µ</span>
            <span id="connection-message">Mode hors-ligne - Les donnÃ©es seront synchronisÃ©es automatiquement</span>
        </div>
    </div>

    <!-- Navigation principale -->
    <nav id="main-nav" class="hidden bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <!-- Logo et titre -->
                <div class="flex items-center">
                    <a href="#/" class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                            <span class="text-white font-bold text-xl">S</span>
                        </div>
                        <div>
                            <h1 class="text-lg font-bold text-gray-900">SAP</h1>
                            <p class="text-xs text-gray-500">Alerte PrÃ©coce</p>
                        </div>
                    </a>
                </div>

                <!-- Menu desktop -->
                <div class="hidden md:flex md:items-center md:space-x-4">
                    <a href="#/dashboard" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-blue-600 hover:bg-blue-50">
                        Tableau de bord
                    </a>
                    <a href="#/collectes" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-blue-600 hover:bg-blue-50">
                        Collectes
                    </a>
                    <a href="#/alertes" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-blue-600 hover:bg-blue-50">
                        Alertes
                    </a>

                    <!-- Admin menu (bailleur only) -->
                    <div id="admin-menu-desktop" class="hidden relative">
                        <button id="admin-menu-button" class="flex items-center space-x-1 px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-blue-600 hover:bg-blue-50">
                            <span>Administration</span>
                            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <div id="admin-menu-dropdown" class="hidden absolute left-0 mt-2 w-56 bg-white rounded-md shadow-lg border border-gray-200 z-50">
                            <a href="#/admin/unites" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">UnitÃ©s de mesure</a>
                            <a href="#/admin/categories" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">CatÃ©gories</a>
                            <a href="#/admin/produits" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Produits</a>
                            <a href="#/admin/departements" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">DÃ©partements</a>
                            <a href="#/admin/communes" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Communes</a>
                            <a href="#/admin/marches" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">MarchÃ©s</a>
                            <hr class="my-1 border-gray-200">
                            <a href="#/admin/import" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 font-semibold">ðŸ“Š Import CSV/Excel</a>
                        </div>
                    </div>

                    <!-- User menu -->
                    <div class="relative">
                        <button id="user-menu-button" class="flex items-center space-x-2 px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-100">
                            <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                                <span class="text-white text-sm font-medium" id="user-initials">U</span>
                            </div>
                            <span id="user-name">Utilisateur</span>
                        </button>

                        <!-- Dropdown menu -->
                        <div id="user-menu-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg border border-gray-200 z-50">
                            <a href="#/profil" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Mon profil</a>
                            <button id="logout-button" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50">
                                DÃ©connexion
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Menu mobile button -->
                <div class="md:hidden flex items-center">
                    <button id="mobile-menu-button" class="inline-flex items-center justify-center p-2 rounded-md text-gray-700 hover:text-blue-600 hover:bg-blue-50">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Menu mobile -->
        <div id="mobile-menu" class="hidden md:hidden border-t border-gray-200">
            <div class="px-2 pt-2 pb-3 space-y-1">
                <a href="#/dashboard" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-blue-600 hover:bg-blue-50">
                    Tableau de bord
                </a>
                <a href="#/collectes" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-blue-600 hover:bg-blue-50">
                    Collectes
                </a>
                <a href="#/alertes" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-blue-600 hover:bg-blue-50">
                    Alertes
                </a>

                <!-- Admin menu (dÃ©cideur only) -->
                <div id="admin-menu-mobile" class="hidden">
                    <div class="px-3 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                        Administration
                    </div>
                    <a href="#/admin/unites" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-blue-600 hover:bg-blue-50 pl-6">
                        UnitÃ©s de mesure
                    </a>
                    <a href="#/admin/categories" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-blue-600 hover:bg-blue-50 pl-6">
                        CatÃ©gories
                    </a>
                    <a href="#/admin/produits" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-blue-600 hover:bg-blue-50 pl-6">
                        Produits
                    </a>
                    <a href="#/admin/departements" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-blue-600 hover:bg-blue-50 pl-6">
                        DÃ©partements
                    </a>
                    <a href="#/admin/communes" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-blue-600 hover:bg-blue-50 pl-6">
                        Communes
                    </a>
                    <a href="#/admin/marches" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-blue-600 hover:bg-blue-50 pl-6">
                        MarchÃ©s
                    </a>
                    <hr class="my-2 border-gray-200">
                    <a href="#/admin/import" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-blue-600 hover:bg-blue-50 pl-6 font-semibold">
                        ðŸ“Š Import CSV/Excel
                    </a>
                </div>

                <a href="#/profil" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-blue-600 hover:bg-blue-50">
                    Mon profil
                </a>
                <button id="mobile-logout-button" class="w-full text-left px-3 py-2 rounded-md text-base font-medium text-red-600 hover:bg-red-50">
                    DÃ©connexion
                </button>
            </div>
        </div>
    </nav>

    <!-- Conteneur principal de l'application -->
    <main id="app" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Le contenu sera injectÃ© ici par le routeur -->
        <div class="flex items-center justify-center min-h-screen">
            <div class="text-center">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                <p class="mt-4 text-gray-600">Chargement...</p>
            </div>
        </div>
    </main>

    <!-- Toast container pour notifications -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2">
        <!-- Les toasts seront injectÃ©s ici -->
    </div>

    <!-- Modal container -->
    <div id="modal-container">
        <!-- Les modals seront injectÃ©s ici -->
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

    <!-- Scripts -->
    <script type="module" src="/modules/api.js"></script>
    <script type="module" src="/modules/ui.js"></script>
    <script type="module" src="/modules/auth.js"></script>
    <script type="module" src="/app.js?v=1738549200"></script>

    <!-- Service Worker Intelligent + Offline Management -->
    <script type="module">
        import { initNetworkDetector } from '/modules/network-detector.js';
        import { initOfflineManager } from '/modules/offline-manager.js';
        import { ApiClient } from '/modules/api.js';
        import { checkAndHandleVersionUpdate, getAppVersion, logVersionInfo, migrateData } from '/modules/version-manager.js';
        import { showUpdateNotification } from '/modules/notification.js';

        // Configuration
        const API_BASE_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:8000'
            : window.location.origin;

        let networkDetector = null;
        let offlineManager = null;
        let serviceWorkerRegistration = null;
        let apiClient = null;

        /**
         * Initialisation au chargement de la page
         */
        window.addEventListener('load', async () => {
            // Ã‰TAPE 0: Gestion de version (CRITIQUE - doit Ãªtre en premier)
            logVersionInfo();
            const storedVersion = localStorage.getItem('app_version');
            const cacheCleared = checkAndHandleVersionUpdate();

            if (cacheCleared) {
                console.warn('âš ï¸  Cache vidÃ© suite Ã  une mise Ã  jour de version');
                console.log('â„¹ï¸  Veuillez vous reconnecter si nÃ©cessaire');

                // Afficher une notification visuelle
                showUpdateNotification();

                // Si l'utilisateur Ã©tait sur une page protÃ©gÃ©e, le rediriger vers login
                if (window.location.hash && !window.location.hash.includes('login')) {
                    // Effectuer la migration des donnÃ©es avant de rediriger
                    if (storedVersion) {
                        migrateData(storedVersion);
                    }

                    // Attendre un peu pour que l'utilisateur voie le message
                    setTimeout(() => {
                        window.location.hash = '#/login';
                        window.location.reload();
                    }, 2000);
                    return;
                }
            }

            console.log('ðŸš€ Initializing Smart Offline System...');

            try {
                // 1. Initialiser ApiClient
                apiClient = new ApiClient(API_BASE_URL);

                // 2. Initialiser OfflineManager
                offlineManager = await initOfflineManager();
                console.log('âœ… OfflineManager initialized');

                // 3. Initialiser NetworkDetector
                networkDetector = initNetworkDetector(API_BASE_URL);
                console.log('âœ… NetworkDetector initialized');

                // 4. Enregistrer Service Worker
                if ('serviceWorker' in navigator) {
                    try {
                        serviceWorkerRegistration = await navigator.serviceWorker.register('/sw-smart.js');
                        console.log('âœ… Service Worker registered:', serviceWorkerRegistration.scope);

                        // Ã‰couter les messages du SW
                        navigator.serviceWorker.addEventListener('message', handleSWMessage);

                        // Mise Ã  jour automatique du SW
                        serviceWorkerRegistration.addEventListener('updatefound', () => {
                            const newWorker = serviceWorkerRegistration.installing;
                            console.log('ðŸ”„ New Service Worker found');

                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'activated') {
                                    console.log('âœ… New Service Worker activated');
                                }
                            });
                        });

                    } catch (error) {
                        console.error('âŒ Service Worker registration failed:', error);
                    }
                }

                // 5. Ã‰couter les changements de connexion
                networkDetector.onStatusChange(handleNetworkChange);

                // 6. Ã‰tat initial
                updateUI(networkDetector.getStatus());

                // 7. Afficher le nombre de collectes en attente
                updatePendingCount();

                // 8. Exposer globalement pour utilisation par d'autres modules et tests
                window.offlineManager = offlineManager;
                window.networkDetector = networkDetector;
                window.syncPendingCollectes = syncPendingCollectes;

                console.log('âœ… Global exports ready');

            } catch (error) {
                console.error('âŒ Initialization error:', error);
            }
        });

        /**
         * GÃ¨re les changements de connexion
         */
        function handleNetworkChange(isOnline, wasOnline) {
            console.log(`ðŸŒ Network changed: ${wasOnline ? 'ONLINE' : 'OFFLINE'} â†’ ${isOnline ? 'ONLINE' : 'OFFLINE'}`);

            // Mettre Ã  jour l'UI
            updateUI(isOnline);

            // Informer le Service Worker
            if (navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({
                    type: 'NETWORK_STATUS',
                    isOnline: isOnline
                });
            }

            // Si on revient online, synchroniser automatiquement
            if (isOnline && !wasOnline) {
                console.log('ðŸ“¶ Back online! Starting automatic sync...');
                setTimeout(() => syncPendingCollectes(), 1000); // DÃ©lai de 1s pour stabilitÃ©
            }
        }

        /**
         * Met Ã  jour l'interface utilisateur
         */
        function updateUI(isOnline) {
            const statusBanner = document.getElementById('connection-status');
            const statusMessage = document.getElementById('connection-message');

            if (!statusBanner || !statusMessage) return;

            if (isOnline) {
                // Mode online
                statusBanner.classList.add('hidden');
                statusBanner.classList.remove('bg-yellow-500', 'bg-red-500');
                statusBanner.classList.add('bg-green-500');
            } else {
                // Mode offline
                statusBanner.classList.remove('hidden', 'bg-green-500');
                statusBanner.classList.add('bg-yellow-500');
                statusMessage.textContent = 'ðŸ“µ Mode hors-ligne - Les donnÃ©es seront synchronisÃ©es automatiquement';
            }
        }

        /**
         * Affiche le nombre de collectes en attente
         */
        async function updatePendingCount() {
            if (!offlineManager) return;

            try {
                const count = await offlineManager.getPendingCount();
                if (count > 0) {
                    const statusMessage = document.getElementById('connection-message');
                    if (statusMessage) {
                        statusMessage.textContent = `ðŸ“µ Mode hors-ligne - ${count} collecte(s) en attente de synchronisation`;
                    }
                }
            } catch (error) {
                console.error('Error getting pending count:', error);
            }
        }

        /**
         * Synchronise les collectes en attente
         */
        async function syncPendingCollectes() {
            if (!offlineManager || !apiClient) {
                console.error('âŒ OfflineManager or ApiClient not initialized');
                return;
            }

            const statusBanner = document.getElementById('connection-status');
            const statusMessage = document.getElementById('connection-message');

            try {
                // Afficher message de sync
                if (statusBanner && statusMessage) {
                    statusBanner.classList.remove('hidden', 'bg-yellow-500');
                    statusBanner.classList.add('bg-blue-500');
                    statusMessage.textContent = 'ðŸ”„ Synchronisation en cours...';
                }

                // Lancer la synchronisation
                const result = await offlineManager.syncPendingCollectes(apiClient);

                if (result.success) {
                    if (result.synced > 0) {
                        // Afficher succÃ¨s
                        if (statusBanner && statusMessage) {
                            statusBanner.classList.remove('bg-blue-500');
                            statusBanner.classList.add('bg-green-500');
                            statusMessage.textContent = `âœ… ${result.synced} collecte(s) synchronisÃ©e(s)`;

                            // Cacher aprÃ¨s 3 secondes
                            setTimeout(() => {
                                statusBanner.classList.add('hidden');
                            }, 3000);
                        }

                        // Notification sonore (optionnel)
                        console.log('âœ… Sync completed successfully');
                    } else {
                        // Aucune collecte Ã  synchroniser
                        if (statusBanner) {
                            statusBanner.classList.add('hidden');
                        }
                    }

                    if (result.failed > 0) {
                        console.warn(`âš ï¸  ${result.failed} collecte(s) failed to sync`);
                    }
                } else {
                    throw new Error(result.error || 'Sync failed');
                }

            } catch (error) {
                console.error('âŒ Sync error:', error);

                // Afficher erreur
                if (statusBanner && statusMessage) {
                    statusBanner.classList.remove('bg-blue-500', 'bg-green-500');
                    statusBanner.classList.add('bg-red-500');
                    statusMessage.textContent = 'âŒ Erreur de synchronisation - RÃ©essai automatique plus tard';

                    // Cacher aprÃ¨s 5 secondes
                    setTimeout(() => {
                        statusBanner.classList.add('hidden');
                    }, 5000);
                }
            }
        }

        /**
         * GÃ¨re les messages du Service Worker
         */
        function handleSWMessage(event) {
            const { data } = event;

            if (data.type === 'OFFLINE_REQUEST') {
                console.log('ðŸ“¥ Offline request intercepted by SW:', data.method, data.url);
                // Le SW a interceptÃ© une requÃªte en mode offline
                // L'application devra la gÃ©rer via OfflineManager
            }

            if (data.type === 'TRIGGER_SYNC') {
                console.log('ðŸ”„ Background sync triggered:', data.tag);
                syncPendingCollectes();
            }
        }

    </script>
</body>
</html>
